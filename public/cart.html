<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>購物車</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-validation" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-validation-body">請填寫所有必填欄位</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="關閉"></button>
    </div>
  </div>
</div>

<header>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="navbar"></nav>
</header>

<script>
fetch('menu.html')
  .then(res => res.text())
  .then(data => document.getElementById('navbar').innerHTML = data);
</script>

<br/><br/>
<div class="container my-5 pt-4">
  <h3 class="mb-4" style="color:#949449;">| 購物車 <small>Shopping Cart</small></h3>

  <div id="checkout-msg" class="alert alert-success text-center" style="display:none;" role="alert"></div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>圖片</th>
          <th>商品名稱</th>
          <th>單價</th>
          <th>數量</th>
          <th>小計</th>
          <th>移除</th>
        </tr>
      </thead>
      <tbody id="cart-body"></tbody>
    </table>
  </div>

  <div id="empty-cart-message" class="text-center text-muted my-4" style="display:none;">
    <i class="bi bi-cart-x fs-1"></i>
    <p class="mt-2">目前購物車沒有商品 <br/>There are currently no items in the shopping cart.</p>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <button class="btn btn-outline-danger" onclick="clearCart()">清空購物車 Clear Shopping Cart</button>
  </div>

  <div class="row justify-content-end mt-4" id="summary-section">
    <div class="col-md-4">
      <div class="border p-3 bg-light rounded">
        <h5 class="mb-3">訂單摘要 Order Summary</h5>
        <p class="d-flex justify-content-between">
          <span>商品總計 Subtotal：</span>
          <span id="subtotal">$0</span>
        </p>
        <p class="d-flex justify-content-between">
          <span>運費 Shipping Fee：</span>
          <span id="shipping">$0</span>
        </p>
        <p class="text-info small" id="free-shipping-msg"></p>
        <hr>
        <p class="d-flex justify-content-between fs-5">
          <span>總金額 Total Amount：</span>
          <span class="text-danger fw-bold" id="grand-total">$0</span>
        </p>
        <button class="btn btn-danger w-100 mt-2" id="checkout-btn">Proceed to Checkout</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Modal 結帳及填寫資料 -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="checkout-form" novalidate>
      <div class="modal-header">
        <h5 class="modal-title" id="checkoutModalLabel">結帳資訊 Checkout Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="name" class="form-label">姓名 Name<span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="name" placeholder="請輸入姓名" required>
          <div class="invalid-feedback">請填寫姓名 Please enter your name</div>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">電話 Phone<span class="text-danger">*</span></label>
          <input type="tel" class="form-control" id="phone" placeholder="請輸入電話" required pattern="^[0-9\-+\s]{6,15}$">
          <div class="invalid-feedback">請填寫有效電話 Please enter a valid phone number</div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">電子郵件 Email<span class="text-danger">*</span></label>
          <input type="email" class="form-control" id="email" placeholder="請輸入電子郵件" required>
          <div class="invalid-feedback">請填寫有效電子郵件 Please enter a valid email address</div>
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">收貨地址 Shipping Address<span class="text-danger">*</span></label>
          <textarea class="form-control" id="address" rows="3" required placeholder="請輸入收貨地址"></textarea>
          <div class="invalid-feedback">請填寫收貨地址 Please enter the shipping address</div>
        </div>

        <div class="mb-3">
          <label class="form-label d-block">付款方式 Payment Method<span class="text-danger">*</span></label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentMethod" id="payCOD" value="貨到付款" required>
            <label class="form-check-label" for="payCOD">貨到付款 Cash on Delivery(COD)</label>
          </div>
          <div class="invalid-feedback d-block" id="payment-invalid-feedback" style="display:none;">請選擇付款方式 Please select a payment method</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-danger">送出訂單</button>
      </div>
    </form>
  </div>
</div>

<script>
async function renderCart() {
  const tbody = document.getElementById('cart-body');
  const emptyMsg = document.getElementById('empty-cart-message');
  const summary = document.getElementById('summary-section');
  tbody.innerHTML = '';

  let cart = [];
  try {
    const res = await fetch("http://localhost:3000/cart");
    if(res.ok) cart = await res.json();
  } catch(err) { console.error(err); }

  if(!cart || cart.length === 0){
    emptyMsg.style.display='block';
    summary.style.display='none';
    return;
  } else {
    emptyMsg.style.display='none';
    summary.style.display='block';
  }

  let total=0;
  cart.forEach(item=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;

    const displayName = item.size ? `${item.name} (${item.size})` : item.name;
    let imgSrc = item.image || 'https://via.placeholder.com/100?text=No+Image';
    if(!imgSrc.startsWith('http')) imgSrc=`http://localhost:3000${imgSrc}`;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><img src="${imgSrc}" alt="${item.name}" width="100"></td>
      <td>${displayName}</td>
      <td>$${item.price}</td>
      <td>
        <input type="number" value="${item.quantity}" min="1" class="form-control text-center" onchange="updateQty('${item.id}', this.value)">
      </td>
      <td>$${subtotal}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="removeItem('${item.id}')">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('subtotal').innerText=`$${total}`;
  const shippingThreshold=1500;
  const shipping = total>=shippingThreshold?0:100;
  document.getElementById('shipping').innerText=`$${shipping}`;
  document.getElementById('grand-total').innerText=`$${total+shipping}`;

  const msgEl=document.getElementById('free-shipping-msg');
  if(total>=shippingThreshold) msgEl.innerText='✅ 已達免運門檻 Free shipping threshold reached.';
  else msgEl.innerText=`⚠ 還差 ${shippingThreshold-total} 可免運費 Spend ${shippingThreshold-total} more to get free shipping.`;
}

async function updateQty(id, qty){
  qty=parseInt(qty);
  if(qty<1) return;
  try{
    const res=await fetch(`http://localhost:3000/cart/${id}`,{
      method:'PUT',
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify({quantity:qty})
    });
    if(!res.ok) throw new Error("更新數量失敗");
    renderCart();
  }catch(err){console.error(err); alert("更新數量失敗");}
}

async function removeItem(id){
  try{
    const res=await fetch(`http://localhost:3000/cart/${id}`,{method:'DELETE'});
    if(!res.ok) throw new Error("刪除失敗");
    renderCart();
  }catch(err){console.error(err); alert("刪除商品失敗");}
}

async function clearCart(){
  if(!confirm('確定清空購物車？Are you sure you want to clear the shopping cart?')) return;
  try{
    const res=await fetch(`http://localhost:3000/cart`,{method:'DELETE'});
    if(!res.ok) throw new Error("清空購物車失敗");
    renderCart();
  }catch(err){console.error(err); alert("清空購物車失敗");}
}

async function sendOrderToBackend(customer, orderData){
  try{
    const res=await fetch("http://localhost:3000/orders",{
      method:"POST",
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify({items:orderData, customer})
    });
    const data=await res.json();
    if(res.ok){
      alert("訂單已送出！");
      await clearCart();
    } else { alert("訂單送出失敗：" + data.error); }
  }catch(err){ console.error(err); alert("無法連線到後端"); }
}

// 前往結帳按鈕打開 Modal
document.getElementById('checkout-btn').addEventListener('click', function(){
  const cartRows=document.getElementById('cart-body').children;
  if(cartRows.length===0){ alert("購物車是空的"); return; }
  new bootstrap.Modal(document.getElementById('checkoutModal')).show();
});

// 結帳表單提交
document.getElementById('checkout-form').addEventListener('submit', async function(event){
  event.preventDefault();
  const nameInput=document.getElementById('name');
  const phoneInput=document.getElementById('phone');
  const emailInput=document.getElementById('email');
  const addressInput=document.getElementById('address');
  const paymentRadios=document.getElementsByName('paymentMethod');
  const paymentInvalidFeedback=document.getElementById('payment-invalid-feedback');
  const phonePattern=/^[0-9\-+\s]{6,15}$/;

  nameInput.classList.toggle('is-invalid', !nameInput.value.trim());
  phoneInput.classList.toggle('is-invalid', !phonePattern.test(phoneInput.value.trim()));
  emailInput.classList.toggle('is-invalid', !emailInput.value.trim() || !emailInput.checkValidity());
  addressInput.classList.toggle('is-invalid', !addressInput.value.trim());

  let paymentSelected=Array.from(paymentRadios).some(r=>r.checked);
  paymentInvalidFeedback.style.display = paymentSelected ? 'none' : 'block';

  if(!nameInput.value.trim() || !phonePattern.test(phoneInput.value.trim()) || 
     !emailInput.value.trim() || !emailInput.checkValidity() ||
     !addressInput.value.trim() || !paymentSelected) return;

  // 取得購物車資料
  let cart=[];
  try{
    const res=await fetch("http://localhost:3000/cart");
    if(res.ok) cart=await res.json();
  }catch(err){ console.error(err); }

  if(!cart || cart.length===0) return alert("購物車是空的");

  const orderData = cart.map(item=>({
    productId:item.id,
    name:item.name,
    size:item.size||"",
    quantity:item.quantity,
    price:item.price,
    image:item.image
  }));

  const customer = {
    name:nameInput.value,
    phone:phoneInput.value,
    email:emailInput.value,
    address:addressInput.value,
    paymentMethod:document.querySelector('input[name="paymentMethod"]:checked').value
  };

  await sendOrderToBackend(customer, orderData);

  const msgEl=document.getElementById('checkout-msg');
  msgEl.innerText='感謝您的訂購！訂單已送出。Thank you for your order! Your order has been placed.';
  msgEl.style.display='block';

  const checkoutModalEl=document.getElementById('checkoutModal');
  bootstrap.Modal.getInstance(checkoutModalEl)?.hide();

  this.reset();
  [nameInput, phoneInput, emailInput, addressInput].forEach(el=>el.classList.remove('is-invalid'));
  paymentInvalidFeedback.style.display='none';
  setTimeout(()=>msgEl.style.display='none',4000);
});

// 頁面載入渲染購物車
renderCart();
</script>
</body>
</html>
