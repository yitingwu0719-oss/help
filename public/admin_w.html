<!DOCTYPE html>
<html>
<head>
    <title>木雕商品管理後台</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .product-img { max-width: 80px; max-height: 80px; object-fit: cover; margin-right: 10px; border-radius: 4px; }
        .img-wrapper { display: inline-flex; align-items: center; margin: 5px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-success">新增/編輯 木雕商品</h2>
    <form id="productForm">
        <div class="form-group">
            <label for="productZhTitle">商品名稱（中文）</label>
            <input type="text" class="form-control" id="productZhTitle" required>
        </div>
        <div class="form-group">
            <label for="productEnTitle">商品名稱（英文）</label>
            <input type="text" class="form-control" id="productEnTitle" required>
        </div>
        <div class="form-group">
            <label for="productZhPrice">價格（中文）</label>
            <input type="text" class="form-control" id="productZhPrice" value="聯絡我們獲得報價" required>
        </div>
        <div class="form-group">
            <label for="productEnPrice">價格（英文）</label>
            <input type="text" class="form-control" id="productEnPrice" value="Contact us for a quote" required>
        </div>
        <div class="form-group">
            <label for="productZhDesc">商品介紹（中文）</label>
            <textarea class="form-control" id="productZhDesc" rows="3" required></textarea>
        </div>
        <div class="form-group">
            <label for="productEnDesc">商品介紹（英文）</label>
            <textarea class="form-control" id="productEnDesc" rows="3" required></textarea>
        </div>
        <div class="form-group">
            <label for="productImages">商品圖片（可多選）</label>
            <input type="file" class="form-control" id="productImages" name="images" multiple accept="image/*">
        </div>
        <div class="form-group" id="existingImages"></div>
        <div class="form-group">
            <label for="productLink">商品頁面連結</label>
            <input type="text" class="form-control" id="productLink" placeholder="例如: wood_commodity/first_w.html" required>
        </div>
        <button type="submit" class="btn btn-primary" id="addProductBtn">新增木雕商品</button>
    </form>

    <hr>

    <h3>已新增木雕商品列表</h3>
    <ul id="productList" class="list-group"></ul>
</div>

<script>
const API_URL = "http://https:///products";
const WOOD_CATEGORY = "wood"; 

const form = document.getElementById('productForm');
const productList = document.getElementById('productList');
const existingImagesDiv = document.getElementById('existingImages');
let editId = null;

// 渲染商品列表 (僅篩選木雕商品)
async function renderProductList() {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("無法取得商品列表");
        
        const allProducts = await res.json();
        // 核心篩選：只顯示 category 為 'wood' 的商品
        const woodProducts = allProducts.filter(p => p.category === WOOD_CATEGORY); 
        
        productList.innerHTML = '';
        
        if (!woodProducts.length) {
            productList.innerHTML = '<li class="list-group-item text-muted">目前沒有任何木雕作品。</li>';
            return;
        }
        
        woodProducts.forEach((product, index) => {
            const firstImage = product.image || "/uploads/no-image.png";
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            li.innerHTML = `
                <div class="d-flex align-items-start">
                    ${firstImage ? `<img src="${firstImage}" alt="商品圖片" class="product-img">` : ''}
                    <div>
                        <a href="${product.link}" target="_blank" class="fw-semibold">
                            ${index + 1}. ${product.zhTitle} <span class="badge bg-secondary">#${product.id}</span>
                        </a>
                        <div class="text-muted small text-truncate" style="max-width: 60ch;">
                            ${product.zhDesc || ''}
                        </div>
                        <div class="small text-danger">
                            ${product.zhPrice || ''}
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-warning btn-sm edit-btn" data-id="${product.id}">編輯</button>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${product.id}">刪除</button>
                </div>
            `;
            productList.appendChild(li);
        });
    } catch (error) {
        console.error("渲染木雕商品列表失敗:", error);
        productList.innerHTML = `<li class="list-group-item text-danger">載入商品失敗: ${error.message}</li>`;
    }
}

// 新增 / 更新商品 (強制設定 category: 'wood')
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append("zhTitle", document.getElementById('productZhTitle').value);
    formData.append("enTitle", document.getElementById('productEnTitle').value);
    formData.append("zhPrice", document.getElementById('productZhPrice').value);
    formData.append("enPrice", document.getElementById('productEnPrice').value);
    formData.append("zhDesc", document.getElementById('productZhDesc').value);
    formData.append("enDesc", document.getElementById('productEnDesc').value);
    formData.append("link", document.getElementById('productLink').value);
    
    // **核心：強制設定類別為 wood**
    formData.append("category", WOOD_CATEGORY); 

    const newFiles = document.getElementById('productImages').files;
    for (let i = 0; i < newFiles.length; i++) {
        formData.append("newImages", newFiles[i]);
    }
    
    let url = API_URL;
    let method = "POST";

    if (editId) {
        const remainingImages = Array.from(existingImagesDiv.querySelectorAll('img')).map(img => img.src);
        formData.append('existingImages', JSON.stringify(remainingImages)); 
        url = `${API_URL}/${editId}`;
        method = "PUT";
    }

    try {
        const res = await fetch(url, { method: method, body: formData });
        const data = await res.json();
        
        if (!res.ok) {
            throw new Error(data.error || "未知錯誤");
        }

        alert(`木雕作品已成功${editId ? '更新' : '新增'}！`);
        
        form.reset();
        existingImagesDiv.innerHTML = '';
        editId = null;
        document.getElementById('addProductBtn').textContent = '新增木雕商品';
        document.getElementById('productImages').value = ''; 
        
        renderProductList(); 
    } catch (err) {
        console.error("新增/更新商品失敗:", err);
        alert(`木雕商品上傳失敗: ${err.message || "請檢查 console"}`);
    }
});

// 編輯 / 刪除
productList.addEventListener('click', async (e) => {
    const id = e.target.dataset.id;
    if (!id) return;

    if (e.target.classList.contains('delete-btn')) {
        if (!confirm("確定要刪除這個木雕商品嗎？")) return;
        try {
            const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error("刪除失敗");
            alert("作品已成功刪除！");
            renderProductList();
        } catch (err) {
             console.error("刪除商品失敗:", err);
             alert("刪除商品失敗，請檢查 console");
        }
    }

    if (e.target.classList.contains('edit-btn')) {
        try {
            const res = await fetch(`${API_URL}/${id}`);
            const product = await res.json();
            
            // 驗證商品類別是否為木雕 (防止從錯誤的後台編輯)
            if (product.category !== WOOD_CATEGORY) {
                return alert("此商品不屬於木雕類別，請到茶壺後台編輯。");
            }
            
            editId = id;
            
            // 載入資料到表單
            document.getElementById('productZhTitle').value = product.zhTitle;
            document.getElementById('productEnTitle').value = product.enTitle;
            document.getElementById('productZhPrice').value = product.zhPrice;
            document.getElementById('productEnPrice').value = product.enPrice;
            document.getElementById('productZhDesc').value = product.zhDesc;
            document.getElementById('productEnDesc').value = product.enDesc;
            document.getElementById('productLink').value = product.link;
            
            // 顯示現有圖片
            existingImagesDiv.innerHTML = '<h4 class="mt-3">現有圖片 (點擊 X 移除)</h4><div class="d-flex flex-wrap" id="imagePreviewContainer"></div>';
            const previewContainer = document.getElementById('imagePreviewContainer');

            product.images.forEach((img) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'img-wrapper';
                
                const imageEl = document.createElement('img');
                imageEl.src = img; 
                imageEl.className = 'product-img';
                wrapper.appendChild(imageEl);

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.textContent = '×';
                delBtn.className = 'btn btn-sm btn-danger ms-1';
                delBtn.addEventListener('click', () => wrapper.remove()); 
                wrapper.appendChild(delBtn);

                previewContainer.appendChild(wrapper);
            });

            document.getElementById('addProductBtn').textContent = '更新木雕商品';
            form.scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            console.error("載入商品資料失敗:", err);
            alert("載入商品資料失敗，請檢查 console");
        }
    }
});

// 初始化載入列表
renderProductList();
</script>
</body>
</html>