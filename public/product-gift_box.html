<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
    .product-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: flex-start;
    }
    .product-card {
        width: 240px;
        flex: 0 0 240px;
    }
    .product-card .card-img-top {
        width: 100%;
        height: 240px;
        object-fit: cover;
        display: block;
        border-radius: 6px 6px 0 0;
    }
    .product-card .card-body {
        padding: .75rem;
    }
    @media (max-width: 576px) {
        .product-card { width: 100%; flex: 0 0 100%; }
    }
    @media (min-width: 577px) and (max-width: 900px) {
        .product-card { width: 45%; flex: 0 0 45%; }
    }
    #langToggleBtn {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1200;
    }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="navbar"></nav>
    </header>

    <!-- 語言切換按鈕 
    <button id="langToggleBtn" class="btn btn-sm btn-outline-light">EN/中</button>-->

    <div id="banner"></div>
    <br/><br/><br/><br/><br/>
    <div class="container my-3">
        <div class="row g-0" style="color: #949449; font-size: 1rem; text-align: center;">
            <h3 class="title my-3" style="font-size: clamp(0.9rem, 3vw, 1.5rem);"
                data-zh="光陰流轉，為它們披上一層溫潤光澤，歲月也沉澱了自然的痕跡。
                       三十餘年的老木雕，蘊藏著獨特紋理與故事。
                       每一道刀痕，皆是匠人心血與歲月的見證。"
                data-en="Time flows, giving them a warm luster. 
                       Decades of woodcarving hold unique textures and stories. 
                       Every cut is a witness to craftsmanship and time.">
                光陰流轉，為它們披上一層溫潤光澤，歲月也沉澱了自然的痕跡。<br/>
                三十餘年的老木雕，蘊藏著獨特紋理與故事。<br/>
                每一道刀痕，皆是匠人心血與歲月的見證。
            </h3>
            <p style="margin-top: 1rem; font-size: clamp(0.8rem, 2vw, 1.2rem);"
               data-zh="靜待知己共賞雕藝。"
               data-en="Awaiting kindred spirits to appreciate the carving together.">
                靜待知己共賞雕藝。
            </p>
        </div>
        <br />
        <div class="product-grid" id="product-container"></div>
    </div>

    <script>
const API_URL = "http://localhost:3000/products"; 
const WOOD_CATEGORY = "wood"; // **定義木雕類別**

document.addEventListener('DOMContentLoaded', () => {

    // 載入 menu-have-color.html 及語言切換邏輯
    fetch('menu-have-color.html')
        .then(res => res.text())
        .then(data => {
            document.getElementById('navbar').innerHTML = data;

            const toggleBtn = document.getElementById('toggle-lang');
            if(toggleBtn){
                const applyLanguage = (lang) => {
                    const selector = lang === "en" ? "[data-en]" : "[data-zh]";
                    document.querySelectorAll(selector).forEach(el => {
                        el.innerText = el.getAttribute(`data-${lang}`);
                    });
                    toggleBtn.innerText = lang === "en" ? "繁體中文" : "English";
                    // 這裡可以選擇將當前語言存入 localStorage
                    // localStorage.setItem('siteLang', lang); 
                };

                toggleBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    const currentLang = toggleBtn.innerText === "English" ? "zh" : "en";
                    applyLanguage(currentLang);
                });

                // 初始語言套用 (如果你的 navbar 邏輯需要)
                // applyLanguage(localStorage.getItem('siteLang') || 'zh');
            }
        });
    
    // 渲染木雕商品
    async function renderWoodProducts() { // 函數名稱改為更明確
        const productContainer = document.querySelector('.product-grid');
        productContainer.innerHTML = '<div class="col-12 text-center text-muted">載入中...</div>'; // 顯示載入中

        try {
            // 從後端 API 撈商品資料
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error("API 請求失敗");

            const allProducts = await res.json();
            
            // =======================================================
            // **核心修正：篩選出 category 為 'wood' 的商品**
            const filteredProducts = allProducts.filter(p => p.category === WOOD_CATEGORY);
            // 由於你的原始程式碼中包含靜態商品，這裡我們合併靜態和篩選後的動態商品
            // 假設你的靜態商品 (staticProducts) 已經確定是木雕
            const staticProducts = []; // 為了安全，將靜態商品清空或直接在後台新增
            const productsToRender = [...staticProducts, ...filteredProducts];
            // =======================================================

            if (productsToRender.length === 0) {
                 productContainer.innerHTML = '<div class="col-12 text-center text-muted">目前沒有任何木雕作品。</div>';
                 return;
            }

            productContainer.innerHTML = ''; // 清空載入中提示

            productsToRender.forEach((product, index) => {
                const productId = `product-${product.id || index}`; // 使用 ID 或索引當作輪播 ID

                // 確保 images 是一個陣列
                const images = Array.isArray(product.images) ? product.images : (product.image ? [product.image] : []);
                
                // 處理無圖情況
                if (images.length === 0) images.push("/uploads/no-image.png");

                const imagesHtml = images.map((imgUrl, imgIndex) => `
                    <div class="carousel-item ${imgIndex===0?'active':''}">
                        <img src="${imgUrl}" class="d-block w-100" alt="${product.zhTitle}" style="height:240px; object-fit:cover; border-radius: 6px 6px 0 0;">
                    </div>
                `).join('');

                const zhTitle = product.zhTitle || product.name || '';
                const enTitle = product.enTitle || product.name || '';
                const zhPrice = product.zhPrice || product.price || '聯絡我們獲得報價';
                const enPrice = product.enPrice || product.price || 'Contact us for a quote';


                const productCard = document.createElement('div');
                productCard.className = 'product-card card';
                productCard.innerHTML = `
                    <div id="${productId}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="2000" style="cursor:pointer;">
                        <div class="carousel-inner">${imagesHtml}</div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#${productId}" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">上一張</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#${productId}" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">下一張</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" data-zh="${zhTitle}" data-en="${enTitle}">
                            ${zhTitle}
                        </h5>
                        <p class="text-danger" data-zh="價格：${zhPrice}" data-en="Price: ${enPrice}">
                            價格：${zhPrice}
                        </p>
                    </div>
                `;

                // 點擊商品跳轉
                productCard.querySelector('.carousel').addEventListener('click', () => {
                    // 使用資料庫中的 link 欄位，如果沒有則使用預設路徑
                    window.location.href = product.link || `./wood_commodity/first_w.html?id=${product.id || index}`;
                });

                productContainer.appendChild(productCard);
            });
            
            // 初始化所有輪播
            document.querySelectorAll('.carousel').forEach(carouselEl => {
                new bootstrap.Carousel(carouselEl, {
                    interval: 2000,
                    ride: 'carousel'
                });
            });

            // 語言套用 (如果語言切換邏輯是放在這個頁面)
            // 假設你的語言設定是存在 localStorage
            // if (typeof applyLanguage === 'function') {
            //     applyLanguage(localStorage.getItem('siteLang') || 'zh');
            // }

        } catch (err) {
            console.error('載入商品失敗:', err);
            productContainer.innerHTML = '<div class="col-12 text-center text-danger">載入商品資料失敗，請檢查後端伺服器是否運行。</div>';
        }
    }

    renderWoodProducts();
});
</script>
</body>
</html>
