<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>商品詳細資訊</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .square-img {
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }
        .carousel-control-prev,
        .carousel-control-next {
            width: 40px;
        }
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-image: none !important;
        }
        .carousel-control-prev-icon::after {
            content: '‹';
            font-size: 3rem;
            color: black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            user-select: none;
            pointer-events: none;
        }
        .carousel-control-next-icon::after {
            content: '›';
            font-size: 3rem;
            color: black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            user-select: none;
            pointer-events: none;
        }
        .thumbnail-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s;
            user-select: none;
        }
        .thumbnail-img.active {
            border-color: #b1cbe7;
        }
        .img-magnifier-glass {
            position: absolute;
            border: 3px solid #000;
            border-radius: 50%;
            cursor: none;
            width: 120px;
            height: 120px;
            box-shadow: 0 0 8px 2px rgba(0,0,0,0.3);
            z-index: 10;
            display: none;
        }
        .img-magnifier-container {
            position: relative;
            display: inline-block;
        }
    </style>
</head>
<body class="container-fluid py-4">

    <div id="navbar"></div>
    <br/>
    <a href="../product-tea_set.html" class="btn btn-outline-secondary mb-3">← 回商品列表</a>

    <div class="row gx-0">
        <div class="col-md-6">
            <div id="carouselExample" class="carousel slide mb-2" data-bs-ride="carousel">
                <div class="carousel-inner" id="carouselInner"></div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">上一張</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">下一張</span>
                </button>
            </div>
            <div class="d-flex justify-content-center gap-2 mb-4" id="thumbnailContainer"></div>
        </div>
        <div class="col-md-6">
            <h1 id="productName">商品名稱</h1>
            <p id="productPrice" class="text-danger fs-4"></p>
            <p id="productDesc"></p>

            <div class="mb-3">
                <label for="quantityInput" class="form-label">數量</label>
                <input type="number" class="form-control" id="quantityInput" value="1" min="1" style="width:100px;">
            </div>
            
            <button id="addToCartBtn" class="btn btn-primary">加入購物車</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
      <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="cartToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="關閉"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 放大鏡功能
        function setupMagnifier(img, zoomLevel = 3) {
            if (!img) return;
            // 這裡你可以維持原本放大鏡函式
        }

        document.addEventListener("DOMContentLoaded", function () {
            // 載入導覽列
            fetch('../menu-have-color.html')
                .then(response => response.text())
                .then(data => document.getElementById('navbar').innerHTML = data)
                .catch(err => console.error("載入 menu.html 錯誤:", err));

            const productIndex = parseInt(new URLSearchParams(window.location.search).get('index'), 10);

            const dynamicProducts = JSON.parse(localStorage.getItem('tea_set')) || [];
            const allProducts = [...dynamicProducts];
            const product = allProducts[productIndex];

            if (!product) {
                document.body.innerHTML = '<p class="text-danger fs-3">找不到商品資料</p><a href="../product-gift_box.html">返回商品列表</a>';
                return;
            }

            // 更新頁面
            document.getElementById('productName').textContent = product.zhTitle;
            document.getElementById('productPrice').textContent = product.zhPrice;
            document.getElementById('productDesc').textContent = product.zhDesc || '暫無描述';

            // 建立輪播與縮圖
            const carouselInner = document.getElementById('carouselInner');
            const thumbnailContainer = document.getElementById('thumbnailContainer');
            product.images.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'carousel-item' + (index === 0 ? ' active' : '');
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-magnifier-container';
                const img = document.createElement('img');
                img.src = src;
                img.alt = `${product.zhTitle} 圖${index+1}`;
                img.className = 'd-block square-img';
                imgContainer.appendChild(img);
                div.appendChild(imgContainer);
                carouselInner.appendChild(div);

                const thumb = document.createElement('img');
                thumb.src = src;
                thumb.className = 'thumbnail-img' + (index === 0 ? ' active' : '');
                thumb.addEventListener('click', () => {
                    bootstrap.Carousel.getOrCreateInstance(document.getElementById('carouselExample')).to(index);
                });
                thumbnailContainer.appendChild(thumb);
            });

            // 縮圖同步
            document.getElementById('carouselExample').addEventListener('slid.bs.carousel', e => {
                const idx = Array.from(carouselInner.children).indexOf(e.relatedTarget);
                document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
                document.querySelectorAll('.thumbnail-img')[idx].classList.add('active');
            });

            // 放大鏡
            setupMagnifier(carouselInner.querySelector('.carousel-item.active img'), 3);

            // 加入購物車
            document.getElementById("addToCartBtn").addEventListener("click", () => {
                const quantity = parseInt(document.getElementById("quantityInput").value);
                if (isNaN(quantity) || quantity < 1) {
                    alert("請輸入有效數量 (至少 1)");
                    return;
                }

                const cart = JSON.parse(localStorage.getItem("cart")) || [];
const existingIndex = cart.findIndex(item => item.id === product.id); // 使用商品的唯一 ID

if (existingIndex >= 0) {
    cart[existingIndex].quantity += quantity;
} else {
            cart.push({
                id: product.zhTitle,
                name: product.zhTitle,
                price: product.zhPrice,
                quantity: quantity,
                image: product.images[0]
            });
        }

                localStorage.setItem("cart", JSON.stringify(cart));

                // 顯示 toast
                const toastEl = document.getElementById("cartToast");
                const toastBody = document.getElementById("cartToastBody");
                toastBody.textContent = `已加入購物車：${product.zhTitle} x ${quantity}`;
                new bootstrap.Toast(toastEl).show();
            });
        });
    </script>
</body>
</html>
