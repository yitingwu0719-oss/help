<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>商品詳細資訊</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('../menu-have-color.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('navbar').innerHTML = data;
                })
                .catch(err => console.error("載入 menu.html 錯誤:", err));
        });
  </script>
  <style>
    .square-img {
      width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    .carousel-control-prev,
    .carousel-control-next {
      width: 40px;
    }
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      background-image: none !important;
    }
    .carousel-control-prev-icon::after {
      content: '‹';
      font-size: 3rem;
      color: black;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
    }
    .carousel-control-next-icon::after {
      content: '›';
      font-size: 3rem;
      color: black;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
    }
    .thumbnail-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s;
      user-select: none;
    }
    .thumbnail-img.active {
      border-color: #b1cbe7;
    }
    .img-magnifier-glass {
      position: absolute;
      border: 3px solid #000;
      border-radius: 50%;
      cursor: none;
      width: 120px;
      height: 120px;
      box-shadow: 0 0 8px 2px rgba(0,0,0,0.3);
      z-index: 10;
      display: none;
    }
    .img-magnifier-container {
      position: relative;
      display: inline-block;
    }
  </style>
</head>
<body class="container-fluid py-4">

  <div id="navbar"></div>
  <br/>
  <a href="../index.html" class="btn btn-outline-secondary mb-3">← 回列表</a>

  <div class="row gx-0">
    <div class="col-md-6">
      <div id="carouselExample" class="carousel slide mb-2" data-bs-ride="carousel">
        <div class="carousel-inner" id="carouselInner"></div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">上一張</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">下一張</span>
        </button>
      </div>
      <div class="d-flex justify-content-center gap-2 mb-4" id="thumbnailContainer"></div>
    </div>

    <div class="col-md-6">
      <h1 id="productName">作品名稱</h1>
      <p id="productPrice" class="text-danger fs-4"></p>
      <p id="productDesc"></p>

      <!-- 尺寸選項 -->
      <div class="mb-3">
        <label for="sizeSelect" class="form-label">尺寸</label>
        <select class="form-select" id="sizeSelect" style="width:200px;">
          <option value="明信片 14.8 x 10.5 cm">明信片 14.8 公分 x 10.5 公分</option>
          <option value="海報 4K">海報 4K</option>
        </select>
      </div>

      <!-- 數量 -->
      <div class="mb-3">
        <label for="quantityInput" class="form-label">數量</label>
        <input type="number" class="form-control" id="quantityInput" value="1" min="1" style="width:100px;">
      </div>

      <button id="addToCartBtn" class="btn btn-primary">加入購物車</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    function setupMagnifier(img, zoomLevel = 3) {
      if (!img) return;

      function initMagnifier() {
        let oldGlass = img.parentElement.querySelector('.img-magnifier-glass');
        if (oldGlass) oldGlass.remove();

        const magnifierGlass = document.createElement('div');
        magnifierGlass.className = 'img-magnifier-glass';
        const container = img.parentElement;
        container.insertBefore(magnifierGlass, img);

        magnifierGlass.style.backgroundImage = `url('${img.src}')`;
        magnifierGlass.style.backgroundRepeat = 'no-repeat';
        magnifierGlass.style.backgroundSize = `${img.width * zoomLevel}px ${img.height * zoomLevel}px`;

        const bw = 3;
        const w = magnifierGlass.offsetWidth / 2;
        const h = magnifierGlass.offsetHeight / 2;

        function getCursorPos(e) {
          const a = img.getBoundingClientRect();
          let x = e.pageX - a.left - window.pageXOffset;
          let y = e.pageY - a.top - window.pageYOffset;
          return { x, y };
        }

        function moveMagnifier(e) {
          e.preventDefault();
          const pos = getCursorPos(e);
          let x = pos.x;
          let y = pos.y;
          if (x > img.width - (w / zoomLevel)) x = img.width - (w / zoomLevel);
          if (x < w / zoomLevel) x = w / zoomLevel;
          if (y > img.height - (h / zoomLevel)) y = img.height - (h / zoomLevel);
          if (y < h / zoomLevel) y = h / zoomLevel;

          magnifierGlass.style.left = `${x - w}px`;
          magnifierGlass.style.top = `${y - h}px`;
          magnifierGlass.style.backgroundPosition = 
            `-${(x * zoomLevel) - w + bw}px -${(y * zoomLevel) - h + bw}px`;
          magnifierGlass.style.display = 'block';
        }

        img.addEventListener('mousemove', moveMagnifier);
        magnifierGlass.addEventListener('mousemove', moveMagnifier);
        img.addEventListener('mouseleave', () => magnifierGlass.style.display = 'none');
        magnifierGlass.addEventListener('mouseleave', () => magnifierGlass.style.display = 'none');
      }

      if (img.complete) {
        initMagnifier();
      } else {
        img.onload = initMagnifier;
      }
    }


    const products = {
      "work07": {
        id: "work07",
        name: "布馬傳奇",
        price: 0,
        priceText: "聯絡我們獲得報價",
        desc: "民俗表演的布馬陣，以鮮豔的大紅為基底，"+
                "徵熱鬧與喜慶；金紙如同紅磚瓦般鋪展，閃耀著傳統節慶的光芒。"+
                "畫面以厚實的底色襯托，再層層疊加色塊，"+
                "讓視覺如舞步般起伏，呈現滿滿的傳統韻味與節奏感。",
        images: ["../images/web-w7.jpg"]
      }
    };

const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    if (!id || !products[id]) {
      document.body.innerHTML = '<p class="text-danger fs-3">找不到商品資料</p><a href="../index.html">返回商品列表</a>';
    } else {
      const product = products[id];
      document.getElementById('productName').textContent = product.name;
      document.getElementById('productPrice').textContent = `價格：${product.priceText}`;
      document.getElementById('productDesc').textContent = product.desc;

      const carouselInner = document.getElementById('carouselInner');
      const thumbnailContainer = document.getElementById('thumbnailContainer');

      product.images.forEach((src, index) => {
        const div = document.createElement('div');
        div.className = 'carousel-item' + (index === 0 ? ' active' : '');
        const imgContainer = document.createElement('div');
        imgContainer.className = 'img-magnifier-container';
        const img = document.createElement('img');
        img.src = src;
        img.alt = `${product.name} 圖${index + 1}`;
        img.className = 'd-block square-img';
        imgContainer.appendChild(img);
        div.appendChild(imgContainer);
        carouselInner.appendChild(div);

        const thumb = document.createElement('img');
        thumb.src = src;
        thumb.className = 'thumbnail-img' + (index === 0 ? ' active' : '');
        thumb.alt = `${product.name} 預覽圖${index + 1}`;
        thumb.dataset.bsSlideTo = index;
        thumb.addEventListener('click', () => {
          const carousel = bootstrap.Carousel.getOrCreateInstance(document.getElementById('carouselExample'));
          carousel.to(index);
          document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
          thumb.classList.add('active');
        });
        thumbnailContainer.appendChild(thumb);
      });

      const carouselEl = document.getElementById('carouselExample');
      carouselEl.addEventListener('slid.bs.carousel', (e) => {
        const idx = Array.from(carouselInner.children).indexOf(e.relatedTarget);
        document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
        if (idx >= 0) document.querySelectorAll('.thumbnail-img')[idx].classList.add('active');
      });

      const firstImg = carouselInner.querySelector('.carousel-item.active img');
      setupMagnifier(firstImg, 3);

      carouselEl.addEventListener('slid.bs.carousel', e => {
        const activeImg = e.relatedTarget.querySelector('img');
        setupMagnifier(activeImg, 3);
      });

      document.getElementById('addToCartBtn').addEventListener('click', () => {
        const quantity = parseInt(document.getElementById('quantityInput').value);
        const size = document.getElementById('sizeSelect').value;
        if (isNaN(quantity) || quantity < 1) {
          alert('請輸入有效的數量 (至少 1)');
          return;
        }
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const existingIndex = cart.findIndex(item => item.id === product.id && item.size === size);
        if (existingIndex >= 0) {
          cart[existingIndex].quantity += quantity;
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: quantity,
            size: size,
            image: product.images[0]
          });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        
        const toastEl = document.getElementById('cartToast');
        const toastBody = document.getElementById('cartToastBody');
        toastBody.textContent = `已加入購物車：${product.name} (${size}) x ${quantity}`;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      });
    };
  </script>

  <!-- Bootstrap Toast 提示訊息 -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="cartToastBody"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="關閉"></button>
      </div>
    </div>
  </div>

</body>
</html>